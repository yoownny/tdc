<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e8e8e8;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .form-label {
            display: inline-block;
            width: 200px;
            margin-right: 10px;
            font-weight: bold;
        }

        input[type="text"], input[type="url"] {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .url-input {
            width: 400px;
        }

        .destination-input {
            width: 230px;
        }

        .header-input {
            width: 400px;
        }

        .message-input {
            width: 290px;
        }

        button {
            padding: 8px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        button:hover {
            background: #40a9ff;
        }

        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
        }

        .checkbox-group label {
            font-weight: normal;
            cursor: pointer;
        }

        .console {
            height: 300px;
            background: #001529;
            color: #fff;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .console .comment {
            color: #52c41a;
        }

        .console .command {
            color: #1890ff;
        }

        .console .error {
            color: #ff4d4f;
        }

        .console .info {
            color: #faad14;
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .subscription-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
        }

        .subscription-destination {
            font-family: 'Courier New', monospace;
            color: #0066cc;
            font-weight: bold;
        }

        .unsubscribe-btn {
            background: #ff4d4f;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 0;
        }

        .unsubscribe-btn:hover {
            background: #ff7875;
        }

        .stomp-section {
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .stomp-section .section-title {
            color: #52c41a;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”Œ WebSocket Debug Tool</h1>

    <!-- ì—°ê²° ì„¤ì • -->
    <div class="form-section">
        <div class="form-row">
            <span class="form-label">URL</span>
            <input type="url" id="urlInput" class="url-input"
                   placeholder="URL to connect, 'ws://' for raw WebSocket or 'http://' for SockJS"
                   value="http://localhost:8080/ws"/>
            <button id="connectBtn">Connect</button>
        </div>

        <div class="form-row">
            <span class="form-label">Connect Type</span>
            <div class="checkbox-group">
                <label><input type="checkbox" id="sockjsCheck"> SockJS</label>
                <label><input type="checkbox" id="stompCheck"> STOMP</label>
            </div>
        </div>
    </div>

    <!-- STOMP ì„¤ì • -->
    <div class="stomp-section">
        <div class="section-title">available if ContentType = STOMP</div>

        <div class="form-row">
            <span class="form-label">STOMP connect header</span>
            <input type="text" id="stompConnectHeader" class="header-input"
                   placeholder='json string, e.g. {"header1":"value1", "header2":"value2"}' disabled/>
        </div>

        <div class="form-row">
            <span class="form-label">STOMP subscribe destination</span>
            <input type="text" id="stompSubscribeDestination" class="destination-input" placeholder="e.g. /topic/test"
                   disabled/>
            <button id="subscribeBtn" disabled>Subscribe</button>
        </div>

        <div class="form-row">
            <span class="form-label">STOMP send header</span>
            <input type="text" id="stompSendHeader" class="header-input"
                   placeholder='json string, e.g. {"header1":"value1", "header2":"value2"}' disabled/>
        </div>

        <div class="form-row">
            <span class="form-label">STOMP send destination</span>
            <input type="text" id="stompSendDestination" class="header-input" placeholder="e.g. /app/test" disabled/>
        </div>
    </div>

    <!-- êµ¬ë… ê´€ë¦¬ -->
    <div class="form-section">
        <div class="form-row">
            <span class="form-label">Active Subscriptions</span>
            <div id="subscriptionsList" style="flex: 1;">
                <div style="color: #999; font-style: italic;">êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ì†¡ì‹  -->
    <div class="form-section">
        <div class="form-row">
            <span class="form-label">Message Content</span>
            <input type="text" id="messageContent" class="message-input" placeholder="message content sent to server"
                   disabled/>
            <button id="sendBtn" disabled>Send</button>
            <button id="clearBtn">Clear Output</button>
        </div>
    </div>

    <!-- ì½˜ì†” ì¶œë ¥ -->
    <div class="form-section">
        <div class="console" id="console">
            <div class="comment"># console output</div>
            <div>$ <span class="pulse">_</span></div>
        </div>
    </div>
</div>

<!-- SockJS & STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let client = null;
    let connected = false;
    let sockjsEnabled = false;
    let stompEnabled = false;
    let activeSubscriptions = []; // êµ¬ë… ëª©ë¡ ê´€ë¦¬

    // DOM ìš”ì†Œë“¤
    const urlInput = document.getElementById('urlInput');
    const connectBtn = document.getElementById('connectBtn');
    const sockjsCheck = document.getElementById('sockjsCheck');
    const stompCheck = document.getElementById('stompCheck');
    const stompConnectHeader = document.getElementById('stompConnectHeader');
    const stompSubscribeDestination = document.getElementById('stompSubscribeDestination');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const stompSendHeader = document.getElementById('stompSendHeader');
    const stompSendDestination = document.getElementById('stompSendDestination');
    const messageContent = document.getElementById('messageContent');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const console = document.getElementById('console');
    const subscriptionsList = document.getElementById('subscriptionsList');

    // ì½˜ì†” ë¡œê·¸ í•¨ìˆ˜
    function log(message) {
        const time = new Date().toLocaleTimeString();
        const logLine = document.createElement('div');

        if (message.startsWith('_ERROR_:')) {
            logLine.className = 'error';
            logLine.innerHTML = `$ <span class="command">${message.replace('_ERROR_:', '')}</span>`;
        } else if (message.startsWith('_INFO_:')) {
            logLine.className = 'info';
            logLine.innerHTML = `$ <span class="command">${message.replace('_INFO_:', '')}</span>`;
        } else {
            logLine.innerHTML = `$ <span class="command">${message}</span>`;
        }

        console.appendChild(logLine);
        console.scrollTop = console.scrollHeight;
    }

    function info(message) {
        log(`_INFO_:${message}`);
    }

    function error(message) {
        log(`_ERROR_:${message}`);
    }

    // êµ¬ë… ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateSubscriptionsList() {
        if (activeSubscriptions.length === 0) {
            subscriptionsList.innerHTML = '<div style="color: #999; font-style: italic;">êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        subscriptionsList.innerHTML = '';
        activeSubscriptions.forEach((sub, index) => {
            const subItem = document.createElement('div');
            subItem.className = 'subscription-item';
            subItem.innerHTML = `
                    <span class="subscription-destination">${sub.destination}</span>
                    <button class="unsubscribe-btn" onclick="unsubscribeDestination(${index})">êµ¬ë…ì·¨ì†Œ</button>
                `;
            subscriptionsList.appendChild(subItem);
        });
    }

    // êµ¬ë… ì·¨ì†Œ
    function unsubscribeDestination(index) {
        const subscription = activeSubscriptions[index];
        if (subscription && subscription.subscription) {
            try {
                subscription.subscription.unsubscribe();
                info(`unsubscribe destination ${subscription.destination} success`);
            } catch (e) {
                error(`unsubscribe destination ${subscription.destination} fail, message = ${e.message}`);
            }
        }
        activeSubscriptions.splice(index, 1);
        updateSubscriptionsList();
    }

    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.unsubscribeDestination = unsubscribeDestination;

    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    sockjsCheck.addEventListener('change', (e) => {
        sockjsEnabled = e.target.checked;
        updateUI();
    });

    stompCheck.addEventListener('change', (e) => {
        stompEnabled = e.target.checked;
        updateUI();
    });

    // UI ì—…ë°ì´íŠ¸
    function updateUI() {
        const isStompAndNotConnected = stompEnabled && !connected;
        const isStompAndConnected = stompEnabled && connected;

        // STOMP connect header (ì—°ê²° ì „ì—ë§Œ í™œì„±í™”)
        stompConnectHeader.disabled = !isStompAndNotConnected;

        // STOMP subscribe/send (ì—°ê²° í›„ì—ë§Œ í™œì„±í™”)
        stompSubscribeDestination.disabled = !isStompAndConnected;
        subscribeBtn.disabled = !isStompAndConnected;
        stompSendHeader.disabled = !isStompAndConnected;
        stompSendDestination.disabled = !isStompAndConnected;

        // ì¼ë°˜ ë©”ì‹œì§€ (ì—°ê²°ë˜ë©´ í™œì„±í™”)
        messageContent.disabled = !connected;
        sendBtn.disabled = !connected;

        // ì—°ê²° ë²„íŠ¼
        connectBtn.textContent = connected ? 'Disconnect' : 'Connect';
        connectBtn.disabled = false;
    }

    // ì—°ê²°/í•´ì œ
    connectBtn.addEventListener('click', () => {
        if (connected) {
            disconnect();
        } else {
            connect();
        }
    });

    function connect() {
        try {
            if (stompEnabled) {
                // STOMP ì—°ê²°
                let ws;
                if (sockjsEnabled) {
                    ws = new SockJS(urlInput.value);
                } else {
                    ws = new WebSocket(urlInput.value);
                }

                client = Stomp.over(ws);

                // Connect header íŒŒì‹±
                let connectHeader = {};
                if (stompConnectHeader.value.trim()) {
                    try {
                        connectHeader = JSON.parse(stompConnectHeader.value);
                    } catch (e) {
                        error(`STOMP connect header format error: ${stompConnectHeader.value}`);
                        return;
                    }
                }

                client.connect(connectHeader, () => {
                    connected = true;
                    updateUI();
                    info(`Connect STOMP server success, url = ${urlInput.value}, connectHeader = ${stompConnectHeader.value}`);
                }, (error) => {
                    connected = false;
                    updateUI();
                    error(`STOMP connect error: ${error}`);
                });

            } else {
                // ì¼ë°˜ WebSocket ë˜ëŠ” SockJS ì—°ê²°
                if (sockjsEnabled) {
                    client = new SockJS(urlInput.value);
                } else {
                    client = new WebSocket(urlInput.value);
                }

                client.binaryType = 'arraybuffer';

                client.onopen = (e) => {
                    connected = true;
                    updateUI();
                    info(`Connect success, url = ${urlInput.value}`);
                };

                client.onmessage = (e) => {
                    info(`Received message: ${e.data}`);
                };

                client.onerror = (e) => {
                    connected = false;
                    updateUI();
                    error(`Connect error, message = ${e.data}, view chrome console for detail`);
                };

                client.onclose = (e) => {
                    connected = false;
                    updateUI();
                    info('Connection closed');
                };
            }

        } catch (e) {
            error(`Connect error, message = ${e.message}, view chrome console for detail`);
            connected = false;
            updateUI();
        }
    }

    function disconnect() {
        if (!connected) {
            error('Not Connected Yet');
            return;
        }

        try {
            if (stompEnabled) {
                client.disconnect();
            } else {
                client.close();
            }
            connected = false;

            // êµ¬ë… ëª©ë¡ ì´ˆê¸°í™”
            activeSubscriptions = [];
            updateSubscriptionsList();

            updateUI();
            info('Close Connection Success');
        } catch (e) {
            error(`disconnect fail, message = ${e.message}, view chrome console for detail`);
        }
    }

    // êµ¬ë…
    subscribeBtn.addEventListener('click', () => {
        if (!stompSubscribeDestination.value.trim()) {
            error('STOMP subscribe destination can not be empty.');
            return;
        }

        if (!stompEnabled) {
            error('Not in STOMP mode');
            return;
        }

        if (!connected) {
            error('Not Connected yet');
            return;
        }

        try {
            const destination = stompSubscribeDestination.value;
            const subscription = client.subscribe(destination, (message) => {
                info(`Receive subscribed message from destination ${destination}, content = ${message.body}`);
            });

            // êµ¬ë… ëª©ë¡ì— ì¶”ê°€
            activeSubscriptions.push({
                destination: stompSubscribeDestination.value,
                subscription: subscription
            });
            updateSubscriptionsList();

            info(`subscribe destination ${stompSubscribeDestination.value} success`);

            // ì…ë ¥ì°½ í´ë¦¬ì–´
            stompSubscribeDestination.value = '';

        } catch (e) {
            error(`subscribe destination ${stompSubscribeDestination.value} fail, message = ${e.message}`);
        }
    });

    // ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener('click', () => {
        try {
            if (stompEnabled) {
                // STOMP ë©”ì‹œì§€ ì „ì†¡
                if (!stompSendDestination.value.trim()) {
                    error('STOMP send destination can not be empty.');
                    return;
                }

                let headerJSON = {};
                if (stompSendHeader.value.trim()) {
                    try {
                        headerJSON = JSON.parse(stompSendHeader.value);
                    } catch (e) {
                        error(`STOMP send header format error: ${stompSendHeader.value}`);
                        return;
                    }
                }

                client.send(stompSendDestination.value, headerJSON, messageContent.value);
                info(`send STOMP message, destination = ${stompSendDestination.value}, content = ${messageContent.value}, header = ${stompSendHeader.value}`);
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€ ì „ì†¡
                client.send(messageContent.value);
                info(`send message, content = ${messageContent.value}`);
            }
        } catch (e) {
            error(`send message fail, message = ${e.message}, view chrome console for detail`);
        }
    });

    // ì½˜ì†” í´ë¦¬ì–´
    clearBtn.addEventListener('click', () => {
        console.innerHTML = `
                <div class="comment"># console output</div>
                <div>$ <span class="pulse">_</span></div>
            `;
    });

    // ì´ˆê¸° UI ì—…ë°ì´íŠ¸
    updateUI();
    updateSubscriptionsList();

    // ë¡œë¹„/ëŒ€ê¸°ë°© í…ŒìŠ¤íŠ¸ìš© ë¹ ë¥¸ ì„¤ì • ë²„íŠ¼ë“¤ ì¶”ê°€
    const quickActionsDiv = document.createElement('div');
    quickActionsDiv.innerHTML = `
            <div style="background: #e6f7ff; padding: 15px; border-radius: 4px; margin: 20px 0;">
                <h3 style="margin: 0 0 15px 0; color: #1890ff;">ğŸ® ê²Œì„ í…ŒìŠ¤íŠ¸ ë¹ ë¥¸ ì„¤ì •</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <button onclick="setLobbyConfig()" style="background: #52c41a;">ì—°ê²° ì„¤ì •</button>
                    <button onclick="sendRoomList()" style="background: #13c2c2;">ë°© ëª©ë¡ ì¡°íšŒ</button>
                    <button onclick="sendRoomCreate()" style="background: #fa541c;">ë°© ìƒì„±</button>
                    <button onclick="sendRoomJoin()" style="background: #1890ff;">ë°© ì…ì¥</button>
                    <button onclick="sendRoomLeave()" style="background: #f5222d;">ë°© í‡´ì¥</button>
                    <button onclick="sendTransferHost()" style="background: #eb2f96;">ë°©ì¥ ê¶Œí•œ ì´ì–‘</button>
                    <button onclick="sendHostResponse()" style="background: #ad4e00;">ë°©ì¥ ê¶Œí•œ ì‘ë‹µ</button>
                    <button onclick="sendRoomChangeResponse()" style="background: #ad4eee;">ë°© ì„¤ì • ë³€ê²½</button>
                    <button onclick="sendProblemChangeResponse()" style="background: #ad000e;">ë°© ë¬¸ì œ ë³€ê²½</button>
                    <button onclick="sendReadyChangeResponse()" style="background: #ee000e;">ì‚¬ìš©ì ì¤€ë¹„ ìƒíƒœ ë³€ê²½</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„¤ì • ë²„íŠ¼ë“¤ì…ë‹ˆë‹¤. ë°© ì…ì¥/ë°©ì¥ ê¶Œí•œ ë“±ì€ ì‹¤ì œ ê°’ì„ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
            </div>
        `;

    document.querySelector('.container').insertBefore(quickActionsDiv, document.querySelector('.form-section:last-child'));

    // ë¹ ë¥¸ ì„¤ì • í•¨ìˆ˜ë“¤
    window.setLobbyConfig = () => {
        sockjsCheck.checked = true;
        stompCheck.checked = true;
        sockjsEnabled = true;
        stompEnabled = true;
        urlInput.value = 'http://localhost:8080/ws';
        stompConnectHeader.value = '{"Authorization": "Bearer eyJhbGciOiJIUzI1NiJ9.eyJjYXRlZ29yeSI6ImFjY2VzcyIsInVzZXJJZCI6MSwibmlja25hbWUiOiJ0ZXN0MTExMSIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNzU0Mjk1ODAyLCJleHAiOjE3NTY4ODc4MDJ9.qe5oXJuK9JRLs7DVe7QJ-NJwrvfHqjV85Eo6k-Vzp1E"}';
        updateUI();
        info('ë¡œë¹„ ì„¤ì • ì™„ë£Œ: SockJS + STOMP, ì¸ì¦ í† í° ì„¤ì •ë¨');
    };

    window.sendRoomList = () => {
        messageContent.value = '{}';
        stompSendDestination.value = '/app/room/list';
        info('ë°© ëª©ë¡ ì¡°íšŒ ë©”ì‹œì§€ ì¤€ë¹„ë¨');
    };

    window.sendRoomCreate = () => {
        messageContent.value = '{     \n' +
            '     "maxPlayers": 4,\n' +
            '     "timeLimit": 12,\n' +
            '     "problemInfo": {\n' +
            '              "problemId": "8",         \n' +
            '              "problemType": "ORIGINAL"     \n' +
            '       }\n' +
            '}';
        stompSendDestination.value = '/app/room/create';
        info('ë°© ìƒì„± ë©”ì‹œì§€ ì¤€ë¹„ë¨ (ë¬¸ì œID: 8)');
    };

    window.sendRoomJoin = () => {
        messageContent.value = '{"roomId": 0}';
        stompSendDestination.value = '/app/room/join';
        info('ë°© ì…ì¥ ë©”ì‹œì§€ ì¤€ë¹„ë¨ (ë°©ID: 1) - ì‹¤ì œ ë°© IDë¡œ ìˆ˜ì •í•˜ì„¸ìš”');
    };

    window.sendRoomLeave = () => {
        messageContent.value = '{"roomId": 0}';
        stompSendDestination.value = '/app/room/leave';
        info('ë°© í‡´ì¥ ë©”ì‹œì§€ ì¤€ë¹„ë¨');
    };

    window.sendTransferHost = () => {
        messageContent.value = '{\n' +
            '    "roomId": 0,\n' +
            '    "targetUserId": 2\n' +
            '}';
        stompSendDestination.value = '/app/room/transfer-host';
        info('ë°©ì¥ ê¶Œí•œ ì´ì–‘ ë©”ì‹œì§€ ì¤€ë¹„ë¨ (ëŒ€ìƒ ìœ ì €ID: 2) - ì‹¤ì œ ìœ ì € IDë¡œ ìˆ˜ì •í•˜ì„¸ìš”');
    };

    window.sendHostResponse = () => {
        messageContent.value = '{\n' +
            '    "roomId": 0,\n' +
            '    "accept": true\n' +
            '}';
        stompSendDestination.value = '/app/room/respond-host-transfer';
        info('ë°©ì¥ ê¶Œí•œ ì‘ë‹µ ë©”ì‹œì§€ ì¤€ë¹„ë¨ (ìˆ˜ë½: true) - acceptë¥¼ falseë¡œ ë³€ê²½í•˜ë©´ ê±°ì ˆ');
    };

    window.sendRoomChangeResponse = () => {
        messageContent.value = '{\n' +
            '    "roomId": 0,\n' +
            '    "maxPlayers": 6,\n' +
            '    "timeLimit": 12\n' +
            '}';
        stompSendDestination.value = '/app/room/settings';
        info('ë°© ë³€ê²½ ë©”ì‹œì§€ ì¤€ë¹„ë¨');
    };

    window.sendProblemChangeResponse = () => {
        messageContent.value = '{\n' +
            '    "problemId": "8",\n' +
            '    "problemType": "ORIGINAL"\n' +
            '}';
        stompSendDestination.value = '/app/room/problem/update';
        info('ë°© ë¬¸ì œ ë³€ê²½ ë©”ì‹œì§€ ì¤€ë¹„ë¨');
    };

    window.sendReadyChangeResponse = () => {
        messageContent.value = '{\n' +
            '    "roomId": 0,\n' +
            '    "readyState": "READY"\n' +
            '}\n';
        stompSendDestination.value = '/app/room/ready';
        info('ì‚¬ìš©ì ìƒíƒœ ë³€ê²½ ë©”ì‹œì§€ ì¤€ë¹„ë¨');
    };

</script>
</body>
</html>