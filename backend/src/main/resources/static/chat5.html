<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ê²Œì„ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }

        input, select, textarea, button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .action-button {
            margin: 5px;
            width: calc(50% - 10px);
            display: inline-block;
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: white;
        }

        .message.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }

        .message.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }

        .timestamp {
            color: #666;
            font-size: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
<h1>ğŸ® WebSocket ê²Œì„ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</h1>

<div class="panel">
    <h2>ğŸ”Œ ì—°ê²° ì„¤ì •</h2>
    <div id="connectionStatus" class="connection-status disconnected">ì—°ê²° ì•ˆë¨</div>

    <div class="form-group">
        <label>ì„œë²„ URL:</label>
        <input type="text" id="serverUrl" value="http://70.12.247.130:8080/ws" placeholder="WebSocket ì„œë²„ URL">
    </div>

    <div class="form-group">
        <label>ì‚¬ìš©ì ID:</label>
        <input type="number" id="userId" value="1" placeholder="ì‚¬ìš©ì ID">
    </div>

    <div class="form-group">
        <label>ë°© ID:</label>
        <input type="number" id="roomId" value="0" placeholder="ë°© ID">
    </div>

    <button onclick="connect()" id="connectBtn">ì—°ê²°</button>
    <button onclick="disconnect()" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
</div>

<div class="container">
    <div class="panel">
        <h2>ğŸ¯ ê²Œì„ ì•¡ì…˜</h2>

        <button class="action-button" onclick="startGame()" id="startGameBtn" disabled>ê²Œì„ ì‹œì‘</button>
        <button class="action-button" onclick="sendQuestion()" id="questionBtn" disabled>ì§ˆë¬¸ ì œì¶œ</button>

        <div class="form-group">
            <label>ì§ˆë¬¸ ë‚´ìš©:</label>
            <textarea id="questionText" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
        </div>

        <button class="action-button" onclick="respondToQuestion()" id="answerBtn" disabled>ë‹µë³€ ì œì¶œ</button>
        <button class="action-button" onclick="sendGuess()" id="guessBtn" disabled>ì •ë‹µ ì‹œë„</button>

        <div class="form-group">
            <label>ë‹µë³€/ì¶”ë¦¬ ë‚´ìš©:</label>
            <textarea id="answerText" placeholder="ë‹µë³€ ë˜ëŠ” ì¶”ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
        </div>
    </div>

    <div class="panel">
        <h2>âš–ï¸ íŒì • & ì±„íŒ…</h2>

        <div class="form-group">
            <label>ì •ë‹µ íŒì •:</label>
            <textarea id="recSenderId" placeholder="ì •ë‹µ ì‹œë„ senderId" rows="3"></textarea>
            <textarea id="recGuess" placeholder="ì •ë‹µ ì‹œë„ guess" rows="3"></textarea>
            <select id="judgeResult">
                <option value="true">ì •ë‹µ</option>
                <option value="false">ì˜¤ë‹µ</option>
            </select>
        </div>

        <button class="action-button" onclick="respondToGuess()" id="judgeBtn" disabled>ì •ë‹µ íŒì •</button>
        <button class="action-button" onclick="sendChat()" id="chatBtn" disabled>ì±„íŒ… ì „ì†¡</button>

        <div class="form-group">
            <label>ì±„íŒ… ë©”ì‹œì§€:</label>
            <textarea id="chatText" placeholder="ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
        </div>
    </div>
</div>

<div class="panel full-width">
    <h2>ğŸ“¨ ë©”ì‹œì§€ ë¡œê·¸</h2>
    <button onclick="clearMessages()" style="width: 100px; float: right;">ë¡œê·¸ ì§€ìš°ê¸°</button>
    <div id="messages" class="messages"></div>
</div>

<script>
    let stompClient = null;
    let currentUserId = null;
    let currentRoomId = null;
    let recQuestionerId = null;
    let recQuestion = null;
    let recSenderId = null;
    let recGuess = null;

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const userId = document.getElementById('userId').value;
        const roomId = document.getElementById('roomId').value;

        if (!serverUrl || !userId || !roomId) {
            alert('ì„œë²„ URL, ì‚¬ìš©ì ID, ë°© IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        currentUserId = parseInt(userId);
        currentRoomId = parseInt(roomId);

        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);

        // í—¤ë”ì— ì‚¬ìš©ì ID ì¶”ê°€ (ì‹¤ì œ êµ¬í˜„ì— ë§ê²Œ ì¡°ì • í•„ìš”)
        const headers = {
            'userId': userId
        };

        stompClient.connect(headers, function(frame) {
            addMessage('ì—°ê²° ì„±ê³µ: ' + frame, 'success');
            updateConnectionStatus(true);
            subscribeToTopics();
        }, function(error) {
            addMessage('ì—°ê²° ì‹¤íŒ¨: ' + error, 'error');
            updateConnectionStatus(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            updateConnectionStatus(false);
            addMessage('ì—°ê²° í•´ì œë¨', 'success');
        }
    }

    function updateConnectionStatus(connected) {
        const status = document.getElementById('connectionStatus');
        const buttons = ['startGameBtn', 'questionBtn', 'answerBtn', 'guessBtn', 'judgeBtn', 'chatBtn'];

        if (connected) {
            status.textContent = 'ì—°ê²°ë¨';
            status.className = 'connection-status connected';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            buttons.forEach(id => document.getElementById(id).disabled = false);
        } else {
            status.textContent = 'ì—°ê²° ì•ˆë¨';
            status.className = 'connection-status disconnected';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            buttons.forEach(id => document.getElementById(id).disabled = true);
        }
    }

    function subscribeToTopics() {
        // ê°œì¸ í êµ¬ë…
        stompClient.subscribe('/user/queue/game', function(message) {
            // message.bodyëŠ” Stringì´ë¯€ë¡œ JSON.parse í•„ìš”
            const parsedBody = JSON.parse(message.body);

            addMessage('ê°œì¸ ë©”ì‹œì§€: ' + message.body, 'success');
            console.log("Parsed body:", parsedBody);
            console.log("eventType:", parsedBody.eventType);
            console.log("payload:", parsedBody.payload);
            console.log("questionRequestDto:", parsedBody.payload?.questionRequestDto);
            console.log("question:", parsedBody.payload?.questionRequestDto?.question);

            if(parsedBody.eventType === "QUESTION_SEND") {
                recQuestionerId = parsedBody.payload.questionRequestDto.senderId;
                recQuestion = parsedBody.payload.questionRequestDto.question;
            }else if(parsedBody.eventType === "RESPOND_QUESTION") {
                recSenderId = parsedBody.payload.nextGuessDto.senderId;
                recGuess = parsedBody.payload.nextGuessDto.guess;
                console.log("ë‹¤ìŒ ì •ë‹µ ì‹œë„: ", recSenderId, recGuess);
                document.getElementById('recSenderId').value = recSenderId;
                document.getElementById('recGuess').value = recGuess;
            }else if(parsedBody.eventType === "GUESS_SEND") {
                recSenderId = parsedBody.payload.senderId;
                recGuess = parsedBody.payload.guess;
                console.log("ë‹¤ìŒ ì •ë‹µ ì‹œë„: ", recSenderId, recGuess);
                document.getElementById('recSenderId').value = recSenderId;
                document.getElementById('recGuess').value = recGuess;
            }
        });

        // ê²Œì„ í† í”½ êµ¬ë…
        stompClient.subscribe('/topic/games/' + currentRoomId + '/game-started', function(message) {
            addMessage('ê²Œì„ ì‹œì‘: ' + message.body, 'success');
        });

        stompClient.subscribe('/topic/games/' + currentRoomId + '/chat', function(message) {
            addMessage('ì±„íŒ…: ' + message.body, 'success');
        });

        stompClient.subscribe('/topic/games/' + currentRoomId + '/history', function(message) {
            addMessage('íˆìŠ¤í† ë¦¬: ' + message.body, 'success');
        });

        stompClient.subscribe('/topic/games/' + currentRoomId, function(message) {
            addMessage('ê²Œì„ ì´ë²¤íŠ¸: ' + message.body, 'success');
        });
    }

    function startGame() {
        if (stompClient && stompClient.connected) {
            stompClient.send('/app/games/' + currentRoomId + '/start', {}, '{}');
            addMessage('ê²Œì„ ì‹œì‘ ìš”ì²­ ì „ì†¡', 'success');
        }
    }

    function sendQuestion() {
        const questionText = document.getElementById('questionText').value;
        if (!questionText.trim()) {
            alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            question: questionText
        };

        if (stompClient && stompClient.connected) {
            stompClient.send('/app/games/' + currentRoomId + '/question', {}, JSON.stringify(payload));
            addMessage('ì§ˆë¬¸ ì „ì†¡: ' + questionText, 'success');
            document.getElementById('questionText').value = '';
        }
    }

    function respondToQuestion() {
        let answerText = document.getElementById('answerText').value;
        if (!answerText.trim()) {
            alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if(answerText === "ì˜ˆ") {
            answerText = "CORRECT";
        }else if(answerText === "ì•„ë‹ˆì˜¤") {
            answerText = "INCORRECT";
        }else {
            answerText = "IRRELEVANT"
        }

        const payload = {
            questionerId: recQuestionerId,
            question: recQuestion,
            answerStatus: answerText
        };

        console.log(`ë‹µë³€!!! ${payload}`);

        if (stompClient && stompClient.connected) {
            stompClient.send('/app/games/' + currentRoomId + '/respond-question', {}, JSON.stringify(payload));
            addMessage('ë‹µë³€ ì „ì†¡: ' + answerText, 'success');
            document.getElementById('answerText').value = '';
        }
    }

    function sendGuess() {
        const guessText = document.getElementById('answerText').value;
        if (!guessText.trim()) {
            alert('ì¶”ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            question: guessText
        };

        if (stompClient && stompClient.connected) {
            stompClient.send('/app/games/' + currentRoomId + '/guess', {}, JSON.stringify(payload));
            addMessage('ì •ë‹µ ì‹œë„ ì „ì†¡: ' + guessText, 'success');
            document.getElementById('answerText').value = '';
        }
    }

    function respondToGuess() {
        const isCorrect = document.getElementById('judgeResult').value === 'true';

        var answerText;
        if(isCorrect === true) {
            answerText = "CORRECT";
        }else {
            answerText = "INCORRECT";
        }

        const payload = {
            senderId: recSenderId, //document.getElementById('recSenderId').value,
            guess: recGuess, //document.getElementById('recGuess').value,
            answerStatus: answerText
        };

        if (stompClient && stompClient.connected) {
            document.getElementById('recSenderId').value = "";
            document.getElementById('recGuess').value = "";
            stompClient.send('/app/games/' + currentRoomId + '/respond-guess', {}, JSON.stringify(payload));
            addMessage('ì •ë‹µ íŒì • ì „ì†¡: ' + (isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'), 'success');
        }
    }

    function sendChat() {
        const chatText = document.getElementById('chatText').value;
        if (!chatText.trim()) {
            alert('ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            message: chatText
        };

        if (stompClient && stompClient.connected) {
            stompClient.send('/app/games/' + currentRoomId + '/chat', {}, JSON.stringify(payload));
            addMessage('ì±„íŒ… ì „ì†¡: ' + chatText, 'success');
            document.getElementById('chatText').value = '';
        }
    }

    function addMessage(message, type = '') {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + type;

        const timestamp = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            const activeElement = document.activeElement;
            if (activeElement.id === 'questionText') {
                sendQuestion();
            } else if (activeElement.id === 'answerText') {
                respondToQuestion();
            } else if (activeElement.id === 'chatText') {
                sendChat();
            }
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('beforeunload', function() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    });
</script>
</body>
</html>